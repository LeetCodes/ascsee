#define ABOUT  "Hello World as cellular automata with a board reference. [Enter] to exit."
int board[35][91] = {
{44,57,70,83,93,102,109,110,108,100,91,81,72,65,62,63,70,80,90,99,106,110,109,104,95,85,72,59,48,38,30,25,22,22,19,22,22,22,22,25,28,36,44,55,69,81,93,102,109,109,106,100,93,90,90,92,99,105,109,108,102,93,81,69,54,42,30,25,22,19,19,19,19,19,19,19,16,16,13,8,8,0,0,0,0,0,0,0,0,0,0},
{48,62,222,255,255,255,255,255,255,255,255,228,146,73,70,73,80,228,255,255,255,255,255,255,255,255,226,66,55,46,38,32,32,30,32,32,32,32,32,32,36,42,49,60,74,219,232,243,251,253,255,110,102,98,96,196,231,241,250,252,254,104,91,76,62,48,40,32,30,30,30,30,30,30,30,28,25,22,19,16,13,8,8,0,0,0,0,0,0,0,0},
{51,66,85,101,116,181,255,255,255,126,115,102,90,80,77,80,88,100,113,125,245,255,255,206,119,105,90,74,62,51,46,44,44,44,46,46,46,46,46,46,48,51,57,66,80,95,109,120,255,255,255,119,111,105,102,106,113,121,240,255,255,113,100,85,70,57,48,44,42,42,44,44,44,44,44,42,40,36,30,25,19,16,13,8,0,0,0,0,0,0,0},
{54,70,88,106,123,138,255,255,255,136,124,110,96,87,83,86,95,108,122,135,231,255,255,160,126,111,95,80,69,60,57,57,57,59,60,60,60,60,60,59,59,60,65,74,86,100,114,125,255,255,255,124,115,110,108,111,118,126,231,255,255,121,108,92,77,65,59,55,55,55,57,57,57,57,57,55,51,48,42,38,30,22,16,13,8,0,0,0,0,0,0},
{51,70,90,110,128,145,255,255,255,146,131,116,104,93,90,92,101,114,129,143,231,255,255,160,132,116,100,86,76,72,70,72,73,76,76,77,77,77,76,74,73,73,76,81,91,105,119,130,255,255,255,130,120,112,110,113,121,131,231,255,255,126,113,99,86,76,72,69,70,72,72,73,73,73,72,70,66,63,57,49,40,32,22,16,13,8,0,0,0,0,0},
{51,70,90,111,131,148,255,255,255,152,138,122,109,99,95,98,108,120,135,151,231,255,255,160,136,120,105,92,85,83,83,87,90,92,92,92,92,92,91,90,87,86,86,90,98,109,121,133,255,255,255,132,122,114,111,114,123,133,231,255,255,132,119,106,95,87,83,83,85,86,87,87,87,87,86,86,83,77,72,62,54,42,30,22,16,8,0,0,0,0,0},
{49,69,90,111,131,151,255,255,255,157,142,126,113,104,100,104,112,124,140,155,231,255,255,160,140,123,109,99,93,95,99,102,106,109,255,255,255,255,255,104,101,99,98,99,104,113,124,136,255,255,255,134,123,115,112,114,123,133,231,255,255,135,124,113,104,99,96,98,99,100,136,255,255,255,255,102,98,92,86,76,65,54,40,28,19,13,8,0,0,0,0},
{49,69,90,111,132,152,255,255,255,161,145,130,116,108,104,108,115,128,143,159,232,255,255,160,142,126,114,106,105,108,113,118,232,253,255,93,92,91,189,254,255,110,106,106,109,116,126,138,255,255,255,134,124,115,112,114,123,134,231,255,255,139,129,119,112,109,109,111,177,255,255,110,99,99,139,247,237,106,100,90,76,62,48,36,25,16,8,0,0,0,0},
{49,69,90,111,132,153,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,161,145,130,119,113,114,120,126,253,255,136,105,103,100,99,98,188,255,231,114,112,114,120,129,140,255,255,255,135,124,115,112,114,123,134,231,255,255,142,133,124,120,119,120,218,255,255,109,106,105,105,107,120,255,254,130,100,87,72,55,42,28,19,13,0,0,0,0},
{49,69,90,112,133,153,255,255,255,162,146,131,118,109,105,109,116,129,145,161,236,255,255,162,146,132,123,120,123,130,251,255,230,117,113,109,106,104,103,130,255,255,170,116,118,122,131,140,255,255,255,135,124,115,112,115,123,134,231,255,255,145,136,130,126,126,167,255,255,130,114,111,109,109,111,114,220,255,251,109,95,79,62,46,32,22,13,8,0,0,0},
{51,70,91,113,133,153,255,255,255,161,145,129,115,106,104,106,114,128,142,158,231,255,255,162,148,135,128,126,130,162,255,255,197,123,120,115,110,107,105,144,255,255,244,119,119,123,132,141,255,255,255,135,125,116,112,115,124,134,231,255,255,146,139,133,131,132,246,255,255,122,118,113,111,111,114,118,165,255,255,153,100,83,66,49,36,25,16,13,8,0,0},
{55,73,93,114,134,153,255,255,255,157,141,126,113,104,100,104,112,125,140,155,231,255,255,162,150,139,131,131,135,210,255,255,255,255,255,255,255,255,255,255,255,255,207,118,118,123,131,140,255,255,255,135,124,115,112,115,123,134,231,255,255,146,140,135,134,135,255,255,255,126,120,115,112,112,115,119,147,255,255,186,102,86,69,54,40,28,22,16,13,8,8},
{62,79,98,118,136,154,255,255,255,154,139,124,111,102,99,102,111,123,139,153,231,255,255,162,151,140,134,133,138,204,255,255,186,158,151,143,138,132,129,126,123,120,116,114,115,120,129,136,255,255,255,133,123,115,112,114,122,133,231,255,255,145,140,136,135,138,255,255,255,126,121,115,112,112,115,118,163,255,255,158,102,87,72,57,44,36,28,22,19,16,13},
{69,85,104,122,140,157,255,255,255,152,138,123,111,102,100,104,112,124,138,152,231,255,255,161,151,141,135,134,139,145,255,255,236,153,147,139,132,128,123,120,116,113,110,109,111,116,124,132,255,255,255,130,121,113,111,113,120,130,231,255,255,141,138,134,134,136,173,255,255,138,120,115,112,111,113,116,217,255,253,112,100,86,72,60,51,44,38,32,28,22,19},
{76,92,110,126,143,158,255,255,255,151,136,123,112,106,105,109,115,126,138,151,232,255,255,162,148,141,135,134,138,142,214,255,255,171,140,133,126,121,116,113,109,255,171,101,104,110,118,125,255,255,255,124,116,110,108,110,115,124,231,255,255,136,133,132,132,134,139,224,255,217,119,114,110,109,109,122,255,255,144,106,95,85,74,65,59,55,49,46,40,32,28},
{86,101,116,133,148,219,255,255,255,165,135,124,116,112,111,115,122,131,140,150,252,255,255,233,146,140,135,134,135,138,141,174,252,255,217,124,119,113,109,161,255,145,93,92,95,101,109,116,255,255,255,116,110,104,101,104,110,116,247,255,255,137,129,128,130,133,136,139,187,255,206,112,107,105,129,255,255,118,106,99,91,83,77,73,70,69,65,60,54,46,38},
{93,109,255,255,255,255,255,255,255,255,255,255,120,119,120,124,131,255,255,255,255,255,255,255,255,255,255,133,133,133,133,132,130,130,255,255,255,255,255,252,90,87,85,85,86,101,255,255,255,255,255,255,255,102,93,96,255,255,255,255,255,255,255,131,128,132,135,138,136,133,255,255,255,255,255,115,102,100,96,91,87,83,81,81,83,83,80,76,69,59,48},
{100,114,129,143,157,166,167,163,155,145,135,129,125,125,130,134,140,146,148,150,150,147,145,141,139,136,134,133,131,129,126,123,119,114,110,104,99,93,90,86,81,77,76,74,77,81,87,92,98,100,99,96,91,88,87,88,92,99,104,109,111,114,116,120,125,131,135,138,136,131,123,115,108,101,98,95,92,90,87,85,85,85,88,92,96,98,96,91,81,70,57},
{139,170,255,255,255,255,255,170,170,142,134,130,170,170,170,255,255,170,170,170,147,142,138,135,170,255,255,255,255,255,170,116,110,104,99,93,90,86,81,79,74,72,70,69,70,73,77,81,86,87,87,86,83,80,80,81,85,90,93,99,102,106,111,172,202,255,255,255,241,131,121,111,101,93,88,85,83,81,80,81,85,88,189,255,255,255,255,234,95,81,66},
{105,120,192,255,255,255,187,162,152,142,134,131,133,139,242,255,255,251,159,153,145,138,133,131,130,130,212,255,255,209,114,106,100,95,90,86,83,80,77,74,72,69,66,65,65,66,70,73,76,79,80,80,79,77,77,79,81,85,88,92,96,101,108,115,124,133,250,255,255,130,120,109,96,88,81,79,77,76,77,81,87,93,104,113,121,251,255,255,108,92,76},
{101,116,133,244,255,255,189,162,152,142,135,133,136,145,154,255,255,252,166,155,146,136,130,128,126,128,128,255,203,115,108,100,93,88,85,83,80,79,77,76,74,72,70,69,66,66,69,70,73,76,77,79,80,80,80,81,83,85,87,90,93,100,108,115,125,135,243,255,255,131,119,106,93,85,79,76,76,77,80,85,92,101,112,123,132,243,255,255,118,101,83},
{96,112,129,149,255,255,253,162,153,143,138,135,140,148,161,250,255,255,172,161,148,136,130,125,124,124,139,255,116,110,102,95,90,86,85,85,83,83,83,81,80,79,77,76,74,73,73,73,76,79,83,86,88,88,90,90,90,90,91,93,96,101,108,116,128,138,243,255,255,132,120,106,95,86,80,79,80,83,87,92,100,109,120,131,141,243,255,255,124,109,88},
{88,105,122,138,245,255,255,183,155,147,141,140,143,152,163,255,255,255,252,165,152,140,132,126,124,123,237,210,112,105,98,92,88,87,88,90,91,91,91,90,90,88,88,87,85,83,81,81,85,87,92,96,100,102,102,101,100,100,99,99,101,105,111,119,130,140,243,255,255,134,122,109,98,90,87,87,90,92,96,101,108,116,128,139,150,243,255,255,131,113,92},
{79,95,113,130,147,255,255,252,159,152,146,145,147,154,188,237,240,255,255,170,158,146,136,130,125,122,255,113,108,100,95,91,91,93,96,99,100,100,121,255,255,109,100,99,98,96,93,93,95,99,105,110,114,116,116,115,112,110,108,111,106,109,113,121,131,141,243,255,255,136,124,113,104,98,96,99,101,104,108,111,115,123,133,145,155,243,255,255,134,116,95},
{69,85,104,121,138,243,255,255,176,158,153,150,151,157,255,174,183,255,255,247,165,153,143,135,129,221,227,110,102,96,93,93,96,101,106,110,230,246,255,112,116,255,253,205,111,109,108,106,108,225,255,253,255,255,142,128,144,255,255,253,255,228,115,122,132,142,243,255,255,139,128,118,110,108,108,111,113,221,255,255,255,255,255,217,159,244,255,255,138,118,98},
{59,74,93,112,130,146,255,255,252,165,159,155,155,169,255,170,177,243,255,255,170,161,151,141,132,255,121,106,99,93,92,96,102,110,162,254,246,93,89,88,88,90,125,255,249,121,119,118,119,122,129,172,255,255,145,255,255,123,118,255,255,255,114,122,131,142,243,255,255,141,131,122,116,115,118,142,254,255,161,100,101,107,118,150,245,254,255,255,139,120,99},
{48,65,83,102,121,138,244,255,255,170,166,162,158,255,159,163,170,176,255,255,245,167,157,146,200,240,113,104,95,91,92,99,108,116,255,255,153,100,96,94,94,97,102,218,255,248,128,126,126,131,138,146,255,255,255,255,134,125,118,151,182,110,112,120,130,141,243,255,255,143,134,126,123,123,126,254,255,209,108,104,104,108,118,132,161,255,255,255,140,121,100},
{40,55,73,92,112,130,146,255,255,249,170,165,159,255,153,154,159,166,240,255,255,170,161,150,253,145,111,100,91,88,91,100,111,221,255,255,108,104,100,96,97,101,108,153,255,255,157,132,133,136,143,152,255,255,255,145,133,122,113,105,101,102,108,116,128,139,243,255,255,145,136,130,128,129,197,255,255,138,112,107,106,108,116,129,141,251,255,255,140,122,101},
{32,48,63,83,102,121,139,243,255,255,170,165,255,177,145,145,148,154,162,255,255,239,162,174,249,122,108,95,87,85,90,100,112,252,255,255,110,107,101,97,98,102,109,138,255,255,204,135,135,139,146,153,255,255,235,142,130,118,106,98,93,95,101,111,123,136,243,255,255,145,138,132,130,132,248,255,255,119,113,108,104,107,113,126,138,244,255,255,140,122,104},
{28,40,55,73,92,111,129,145,255,255,249,162,255,142,135,133,135,141,150,244,255,255,162,251,168,118,102,90,81,80,86,96,110,243,255,255,110,106,101,97,98,102,109,136,255,255,191,133,134,138,145,152,255,255,177,138,124,111,99,90,85,87,95,106,119,132,243,255,255,142,135,131,130,132,243,255,255,119,113,107,104,106,112,123,135,246,255,255,139,123,105},
{22,32,48,63,81,100,118,133,242,255,255,255,201,132,124,121,122,128,136,146,255,255,255,253,126,112,96,83,74,74,80,91,105,181,255,255,130,102,98,96,97,100,106,179,255,255,131,129,129,133,139,146,255,255,147,131,118,102,90,80,76,79,87,100,114,128,243,255,255,139,132,128,126,129,185,255,255,136,110,106,102,104,109,120,132,254,255,255,138,122,105},
{16,25,40,54,72,88,106,121,141,255,255,255,130,120,112,108,109,114,122,131,243,255,255,190,116,102,87,74,66,66,73,83,96,109,240,255,206,97,95,93,94,96,100,255,255,204,123,121,121,125,131,136,255,255,142,122,110,95,81,72,69,72,80,93,109,121,243,255,255,131,125,121,120,121,125,249,255,227,106,101,98,100,106,114,188,255,255,255,132,120,105},
{13,22,32,46,60,76,92,108,119,242,255,220,116,108,99,93,93,99,108,116,146,255,254,116,105,91,77,65,59,57,63,74,86,98,106,223,255,172,88,87,87,88,255,255,190,114,112,111,111,115,121,172,255,255,177,113,100,86,73,65,62,65,74,86,100,112,248,255,255,121,116,112,110,111,115,119,246,255,211,95,94,95,98,255,255,248,255,255,129,114,101},
{8,16,25,38,49,65,79,92,102,139,255,110,101,92,85,79,79,85,92,100,108,246,212,101,91,79,66,55,48,48,54,62,74,85,93,100,111,255,255,255,255,255,184,106,104,101,99,98,99,192,255,255,255,255,255,255,193,121,65,57,55,59,66,106,195,255,255,255,255,255,255,161,99,99,102,106,110,152,255,248,252,245,255,126,124,222,255,255,255,212,153},
{8,13,19,28,40,54,65,77,86,92,93,91,86,77,70,65,65,69,76,85,90,92,91,86,77,66,55,46,40,40,44,51,62,72,80,87,91,93,95,96,96,95,95,92,90,87,85,83,85,88,92,98,100,100,95,87,77,66,57,49,48,49,57,69,79,88,95,99,99,95,91,86,85,85,88,92,96,99,101,101,102,102,105,109,111,112,112,109,102,93,85}
};
#include <stdio.h>
#include <fcntl.h>
#define MAX(a,b) (((a) > (b)) ? (a) : (b))
#define MIN(a,b) (((a) < (b)) ? (a) : (b))
/* (death) larva stage -> pupa -> maturity */
#define MAP " .',:;=*i!|lX@#"
int main(){
	fd_set fd_r;
	srand(time(0));
	struct timeval ts;
	const int wid = 91, 
	      hei = 35, 
	      cutoff = 225, 
	      reproduce = rand() % 40 + 10, 
	      dieoff = rand() % 5 + 1,
	      move = rand() % 20 + 1, 
	      moveCost = rand() % 50 + 1, 
	      tps = 300;

	int	ix = 0,
		iy,
		i,
		j,
		life[35][91] = {{0}},
		*flat = (int*)life,
		turn = 0,
		best, 
		bstIx, 
		bstIy, 
		limI, 
		limJ;

	ts.tv_sec = 0;
	printf("%s (%d tps)\n\n", ABOUT, tps);
	flat[rand() % (hei * wid)] = 32;

	for(;;turn++) {
		for(ix = 0; ix < hei; ix++) {
			for(iy = 0; iy < wid; iy++) {
				if( (turn&0xf) == 0) { 
					putchar(MAP[life[ix][iy] >> 4]);
				}
				if(life[ix][iy] > 0) {
					if(life[ix][iy] > board[ix][iy] && (rand() % (board[ix][iy] + 1)) < dieoff ) { /* dies */
						life[ix][iy] = 0;
					} else if(rand() % reproduce == 0) { /* reproduces */
							limI = MIN(ix + 2, hei);
							limJ = MIN(iy + 2, wid);
							for(i = MAX(ix - 1, 0); i < limI; i++){
								for(j = MAX(iy - 1, 0); j < limJ; j++){
								if(life[i][j] == 0 && (rand() % 16 == 0)) {
									life[i][j] = 1;
								}
							}
						}
					} else if(rand() % move == 0) { /* move to a better spot */
							best = board[ix][iy]; /* current position */
							limI = MIN(ix + 1, hei);
							limJ = MIN(iy + 1, wid);
							for(i = MAX(ix - 1, 0); i < limI; i++){
								for(j = MAX(iy - 1, 0); j < limJ; j++){
									if(life[i][j] == 0) {
										if(board[i][j] > best) {
											bstIx = i;
											bstIy = j;
											best = board[i][j];
										}
									}
								}
							}
							if(best != board[ix][iy]) {	/* found a new spot */
								life[bstIx][bstIy] = MIN(life[ix][iy] + 1, cutoff);
								life[ix][iy] = 0;
							}
					} else if(rand() % moveCost == 0) { /* moving is more expensive then staying */
						life[ix][iy]++; 
						if(life[ix][iy] > cutoff) {
							life[ix][iy] = cutoff;
						}
					}
				}
			}
			if((turn & 0xf) == 0) {
				putchar('\n');
			}
		}
		FD_ZERO(&fd_r);
		FD_SET(0, &fd_r);
		ts.tv_usec = 1000000 / tps;
		select(1, &fd_r, NULL, NULL, &ts);
		if(FD_ISSET(0, &fd_r)) { 
			return(0);
		}
		if((turn & 0xf) == 0) {
			printf("\033[35A");
		}
	}
	return 0;
}
